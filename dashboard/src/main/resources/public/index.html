<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EDAF Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
        header { background: #1976D2; color: white; padding: 16px 24px; display: flex; align-items: center; gap: 16px; }
        header h1 { font-size: 20px; font-weight: 600; }
        .status { font-size: 12px; padding: 4px 8px; border-radius: 4px; }
        .status.connected { background: #4CAF50; }
        .status.disconnected { background: #f44336; }
        .container { max-width: 1200px; margin: 24px auto; padding: 0 24px; }
        .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
        .card h2 { font-size: 16px; color: #555; margin-bottom: 12px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .stat { text-align: center; }
        .stat .value { font-size: 28px; font-weight: 700; color: #1976D2; }
        .stat .label { font-size: 12px; color: #999; margin-top: 4px; }
        #chartContainer { position: relative; height: 350px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { padding: 8px 12px; text-align: right; border-bottom: 1px solid #eee; }
        th { text-align: center; color: #777; font-weight: 600; }
        #genTable { max-height: 300px; overflow-y: auto; }
    </style>
</head>
<body>
    <header>
        <h1>EDAF Dashboard</h1>
        <span id="statusBadge" class="status disconnected">Disconnected</span>
    </header>
    <div class="container">
        <div class="card">
            <h2>Current Run</h2>
            <div class="stats-grid">
                <div class="stat"><div class="value" id="algName">-</div><div class="label">Algorithm</div></div>
                <div class="stat"><div class="value" id="genCount">0</div><div class="label">Generation</div></div>
                <div class="stat"><div class="value" id="bestFit">-</div><div class="label">Best Fitness</div></div>
                <div class="stat"><div class="value" id="avgFit">-</div><div class="label">Avg Fitness</div></div>
            </div>
        </div>
        <div class="card">
            <h2>Convergence</h2>
            <div id="chartContainer"><canvas id="chart"></canvas></div>
        </div>
        <div class="card">
            <h2>Generation History</h2>
            <div id="genTable">
                <table>
                    <thead><tr><th>Gen</th><th>Best</th><th>Worst</th><th>Avg</th><th>Std</th></tr></thead>
                    <tbody id="genBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        const bestData = [], avgData = [], labels = [];
        const ctx = document.getElementById('chart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Best', data: bestData, borderColor: '#2196F3', borderWidth: 2, pointRadius: 0, fill: false },
                    { label: 'Average', data: avgData, borderColor: '#FF9800', borderWidth: 2, pointRadius: 0, fill: false }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    x: { title: { display: true, text: 'Generation' } },
                    y: { title: { display: true, text: 'Fitness' } }
                }
            }
        });

        function connect() {
            const es = new EventSource('/sse/events');
            es.onopen = () => {
                document.getElementById('statusBadge').textContent = 'Connected';
                document.getElementById('statusBadge').className = 'status connected';
            };
            es.onerror = () => {
                document.getElementById('statusBadge').textContent = 'Disconnected';
                document.getElementById('statusBadge').className = 'status disconnected';
            };
            es.addEventListener('algorithmStarted', (e) => {
                const d = JSON.parse(e.data);
                document.getElementById('algName').textContent = d.algorithmId;
                document.getElementById('genCount').textContent = '0';
                document.getElementById('bestFit').textContent = '-';
                document.getElementById('avgFit').textContent = '-';
                bestData.length = 0; avgData.length = 0; labels.length = 0;
                document.getElementById('genBody').innerHTML = '';
                chart.update();
            });
            es.addEventListener('generationCompleted', (e) => {
                const d = JSON.parse(e.data);
                document.getElementById('genCount').textContent = d.generation;
                document.getElementById('bestFit').textContent = d.bestFitness.toFixed(6);
                document.getElementById('avgFit').textContent = d.avgFitness.toFixed(6);
                labels.push(d.generation);
                bestData.push(d.bestFitness);
                avgData.push(d.avgFitness);
                chart.update();
                const row = `<tr><td>${d.generation}</td><td>${d.bestFitness.toFixed(6)}</td><td>${d.worstFitness.toFixed(6)}</td><td>${d.avgFitness.toFixed(6)}</td><td>${d.stdFitness.toFixed(6)}</td></tr>`;
                document.getElementById('genBody').insertAdjacentHTML('afterbegin', row);
            });
            es.addEventListener('algorithmTerminated', (e) => {
                document.getElementById('algName').textContent += ' (Done)';
            });
        }
        connect();
    </script>
</body>
</html>
